<html>
<head>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 16px;
      margin: 0;
      background: #f8f9fa;
    }
    .dashboard {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .header { 
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .stats { 
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }
    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      flex: 1;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #18a0fb;
    }
    .section { 
      margin: 25px 0;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
    }
    .property-list { 
      max-height: 120px;
      overflow-y: auto;
      margin: 10px 0;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
    }
    .property-item { 
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .property-item:hover { background: #f5f5f5; }
    .property-item.selected { background: #e3f2fd; }
    .property-item input { margin-right: 8px; }
    .binding-item { 
      background: #f8f9fa;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 4px solid #18a0fb;
    }
    .btn { 
      background: #18a0fb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn-danger { background: #dc3545; }
    .btn-success { background: #28a745; }
    .footer { 
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }
    .refresh-status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <h3>组件属性批量刷新</h3>
      <div id="component-info"></div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="instance-count">0</div>
          <div>实例数量</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="binding-count">0</div>
          <div>绑定数量</div>
        </div>
      </div>
    </div>

    <!-- 绑定管理区域 -->
    <div class="section">
      <h4>创建新绑定</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
        <div>
          <label>文本属性:</label>
          <div id="text-properties" class="property-list"></div>
        </div>
        <div>
          <label>实例交换属性:</label>
          <div id="instance-properties" class="property-list"></div>
        </div>
      </div>
      <button id="create-binding-btn" class="btn" disabled>创建绑定</button>
    </div>

    <!-- 现有绑定列表 -->
    <div class="section">
      <h4>现有绑定配置</h4>
      <div id="existing-bindings"></div>
    </div>

    <!-- 批量刷新区域 -->
    <div class="section">
      <h4>批量刷新实例</h4>
      <p>将自动更新所有实例的绑定文本属性</p>
      <div id="refresh-status"></div>
      <button id="refresh-all-btn" class="btn btn-success">刷新所有实例</button>
    </div>

    <div class="footer">
      <button id="cancel-btn" class="btn">关闭</button>
      <div id="action-status"></div>
    </div>
  </div>

  <script src="ui.js"></script>
</body>
</html>
<script>

let selectedTextProperty = null;
let selectedInstanceProperty = null;
let currentComponentKey = null;
let currentInstanceCount = 0;

window.addEventListener('load', () => {
  document.getElementById('cancel-btn').addEventListener('click', () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
  });

  document.getElementById('create-binding-btn').addEventListener('click', createBinding);
  document.getElementById('refresh-all-btn').addEventListener('click', refreshAllInstances);
});

onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  switch (msg.type) {
    case 'show-component-dashboard':
      showComponentDashboard(msg);
      break;
    case 'show-error':
      showError(msg.message);
      break;
    case 'binding-created':
      handleBindingCreated(msg.binding);
      break;
    case 'binding-deleted':
      handleBindingDeleted(msg.textProperty);
      break;
    case 'refresh-completed':
      showRefreshResults(msg);
      break;
  }
};

function showComponentDashboard(data) {
  currentComponentKey = data.componentKey;
  currentInstanceCount = data.instanceCount;
  
  // 更新组件信息
  document.getElementById('component-info').innerHTML = `
    <strong>组件:</strong> ${data.componentName}
  `;
  
  // 更新统计信息
  document.getElementById('instance-count').textContent = data.instanceCount;
  document.getElementById('binding-count').textContent = data.existingBindings.length;
  
  // 显示属性列表
  renderPropertyList('text-properties', data.textProperties, 'text');
  renderPropertyList('instance-properties', data.instanceProperties, 'instance');
  
  // 显示现有绑定
  renderExistingBindings(data.existingBindings);
  
  // 更新按钮状态
  updateButtonStates();
}

function renderPropertyList(containerId, properties, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  if (properties.length === 0) {
    container.innerHTML = '<div class="property-item">无可用属性</div>';
    return;
  }
  
  properties.forEach(property => {
    const div = document.createElement('div');
    div.className = 'property-item';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'radio';
    checkbox.name = type + '-property';
    checkbox.addEventListener('change', () => selectProperty(property, type));
    
    div.appendChild(checkbox);
    div.appendChild(document.createTextNode(property));
    container.appendChild(div);
  });
}

function selectProperty(property, type) {
  // 更新选择
  if (type === 'text') {
    selectedTextProperty = property;
  } else {
    selectedInstanceProperty = property;
  }
  
  // 更新按钮状态
  updateButtonStates();
}

function updateButtonStates() {
  const createBtn = document.getElementById('create-binding-btn');
  const refreshBtn = document.getElementById('refresh-all-btn');
  
  createBtn.disabled = !(selectedTextProperty && selectedInstanceProperty);
  refreshBtn.disabled = currentInstanceCount === 0;
}

function createBinding() {
  if (selectedTextProperty && selectedInstanceProperty) {
    parent.postMessage({
      pluginMessage: {
        type: 'create-binding',
        componentKey: currentComponentKey,
        textProperty: selectedTextProperty,
        instanceProperty: selectedInstanceProperty
      }
    }, '*');
  }
}

function handleBindingCreated(binding) {
  // 更新绑定计数
  const bindingCount = document.getElementById('binding-count');
  bindingCount.textContent = parseInt(bindingCount.textContent) + 1;
  
  // 添加到绑定列表
  const container = document.getElementById('existing-bindings');
  const bindingElement = createBindingElement(binding);
  container.appendChild(bindingElement);
  
  // 清空选择
  clearSelection();
  showStatus('绑定创建成功!', 'success');
}

function handleBindingDeleted(textProperty) {
  // 从UI中移除绑定项
  const element = document.querySelector(`[data-binding="${textProperty}"]`);
  if (element) {
    element.remove();
  }
  
  // 更新绑定计数
  const bindingCount = document.getElementById('binding-count');
  bindingCount.textContent = parseInt(bindingCount.textContent) - 1;
  
  showStatus('绑定已删除', 'success');
}

function renderExistingBindings(bindings) {
  const container = document.getElementById('existing-bindings');
  container.innerHTML = '';
  
  if (bindings.length === 0) {
    container.innerHTML = '<p>暂无绑定配置</p>';
    return;
  }
  
  bindings.forEach(binding => {
    container.appendChild(createBindingElement(binding));
  });
}

function createBindingElement(binding) {
  const div = document.createElement('div');
  div.className = 'binding-item';
  div.setAttribute('data-binding', binding.textProperty);
  
  div.innerHTML = `
    <div style="display: flex; justify-content: between; align-items: center;">
      <div style="flex: 1;">
        <strong>${binding.textProperty}</strong> 
        <span>←</span>
        <strong>${binding.instanceProperty}</strong>
      </div>
      <button class="btn btn-danger" onclick="deleteBinding('${binding.textProperty}')">删除</button>
    </div>
  `;
  
  return div;
}

function refreshAllInstances() {
  const refreshBtn = document.getElementById('refresh-all-btn');
  refreshBtn.disabled = true;
  refreshBtn.textContent = '刷新中...';
  
  parent.postMessage({
    pluginMessage: {
      type: 'refresh-all',
      componentKey: currentComponentKey
    }
  }, '*');
}

function showRefreshResults(data) {
  const refreshBtn = document.getElementById('refresh-all-btn');
  refreshBtn.disabled = false;
  refreshBtn.textContent = '刷新所有实例';
  
  const statusDiv = document.getElementById('refresh-status');
  statusDiv.className = `refresh-status status-${data.success === data.total ? 'success' : 'error'}`;
  statusDiv.innerHTML = `
    <strong>刷新完成:</strong> ${data.success}/${data.total} 个实例更新成功
    ${data.results && data.results.some(r => !r.success) ? 
      '<br><details style="margin-top: 10px;"><summary>查看错误详情</summary>' + 
      data.results.filter(r => !r.success).map(r => `${r.instance}: ${r.error}`).join('<br>') + 
      '</details>' : ''}
  `;
}

function deleteBinding(textProperty) {
  if (confirm('确定要删除这个绑定吗？')) {
    parent.postMessage({
      pluginMessage: {
        type: 'delete-binding',
        componentKey: currentComponentKey,
        textProperty: textProperty
      }
    }, '*');
  }
}

function clearSelection() {
  selectedTextProperty = null;
  selectedInstanceProperty = null;
  
  // 清除所有单选按钮的选择
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
  });
  
  updateButtonStates();
}

function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('action-status');
  statusDiv.textContent = message;
  statusDiv.style.color = type === 'success' ? '#28a745' : '#dc3545';
  
  setTimeout(() => {
    statusDiv.textContent = '';
  }, 3000);
}

function showError(message) {
  document.body.innerHTML = `
    <div style="padding: 20px; text-align: center;">
      <h3 style="color: #dc3545;">错误</h3>
      <p>${message}</p>
      <button class="btn" onclick="window.location.reload()">重新加载</button>
    </div>
  `;
}
</script>
